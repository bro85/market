(self.webpackChunkbuildmarket_angular=self.webpackChunkbuildmarket_angular||[]).push([[265],{4265:(e,t,i)=>{"use strict";i.r(t),i.d(t,{AddProductModule:()=>W});var r=i(1116),o=i(1334),s=i(1462),n=i(2925),c=i(2193),a=i(5366),u=i(6455),l=i(2935),d=i(5763),f=i(2693),m=i(5031),p=i(8207),g=i(5540),h=i(9252),Z=i(3070),v=i(3841),_=i(7064),T=i(9550),y=i(4369),b=i(1285),q=i(1601),A=i(6761);function x(e,t){if(1&e&&(a.TgZ(0,"mat-option",23),a._uU(1),a.qZA()),2&e){const e=t.$implicit;a.s9C("value",e.id),a.xp6(1),a.Oqu(e.title)}}function w(e,t){if(1&e&&(a.ynx(0),a.YNc(1,x,2,2,"mat-option",22),a.BQk()),2&e){const e=a.oxw();a.xp6(1),a.Q6J("ngForOf",e.types)}}function I(e,t){1&e&&(a.TgZ(0,"div",25),a._uU(1,"\u041e\u0431\u0435\u0440\u0456\u0442\u044c \u0442\u0438\u043f \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA())}function N(e,t){if(1&e&&(a.TgZ(0,"div"),a.YNc(1,I,2,0,"div",24),a.qZA()),2&e){const e=a.oxw();a.xp6(1),a.Q6J("ngIf",e.form.get("type").errors.required)}}function S(e,t){1&e&&(a.TgZ(0,"div",25),a._uU(1,"\u0412\u0432\u0435\u0434\u0456\u0442\u044c \u043d\u0430\u0437\u0432\u0443 \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA())}function k(e,t){1&e&&(a.TgZ(0,"div",25),a._uU(1,"\u0422\u0430\u043a\u0430 \u043d\u0430\u0437\u0432\u0430 \u0432\u0436\u0435 \u0456\u0441\u043d\u0443\u0454"),a.qZA())}function J(e,t){if(1&e&&(a.TgZ(0,"div"),a.YNc(1,S,2,0,"div",24),a.YNc(2,k,2,0,"div",24),a.qZA()),2&e){const e=a.oxw();a.xp6(1),a.Q6J("ngIf",e.form.get("title").errors.required),a.xp6(1),a.Q6J("ngIf",e.form.get("title").errors.busyTitle)}}function P(e,t){if(1&e){const e=a.EpF();a.TgZ(0,"div",3),a.TgZ(1,"app-selected-files",26),a.NdJ("removeFile",function(t){return a.CHM(e),a.oxw().removeSelectedFile(t)}),a.qZA(),a.qZA()}if(2&e){const e=a.oxw();a.xp6(1),a.Q6J("selectedFiles",e.selectedFiles)}}function F(e,t){1&e&&(a.TgZ(0,"div",25),a._uU(1,"\u0414\u043e\u0434\u0430\u0439\u0442\u0435 \u0456\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0456\u044e \u043e \u0442\u043e\u0432\u0430\u0440\u0456"),a.qZA())}function C(e,t){if(1&e&&(a.TgZ(0,"div"),a.YNc(1,F,2,0,"div",24),a.qZA()),2&e){const e=a.oxw();a.xp6(1),a.Q6J("ngIf",e.form.get("info").errors.required)}}function U(e,t){1&e&&(a.TgZ(0,"div",25),a._uU(1,"\u0412\u0432\u0435\u0434\u0456\u0442\u044c \u0432\u0430\u0440\u0442\u0456\u0441\u0442\u044c \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA())}function Y(e,t){if(1&e&&(a.TgZ(0,"div"),a.YNc(1,U,2,0,"div",24),a.qZA()),2&e){const e=a.oxw();a.xp6(1),a.Q6J("ngIf",e.form.get("price").errors.required)}}function Q(e,t){if(1&e&&(a.TgZ(0,"mat-form-field",35),a._UZ(1,"input",36),a.qZA()),2&e){const e=a.oxw().index;a.xp6(1),a.s9C("formControlName",e)}}function O(e,t){if(1&e){const e=a.EpF();a.TgZ(0,"mat-form-field",37),a.NdJ("keydown",function(t){return a.CHM(e),a.oxw(3).inputJustNumbers(t)}),a._UZ(1,"input",36),a.qZA()}if(2&e){const e=a.oxw().index;a.xp6(1),a.s9C("formControlName",e)}}function E(e,t){if(1&e&&(a.TgZ(0,"span",38),a._uU(1),a.qZA()),2&e){const e=a.oxw().$implicit;a.xp6(1),a.Oqu(e.unit)}}function D(e,t){if(1&e&&(a.TgZ(0,"li",31),a.TgZ(1,"div"),a._uU(2),a.qZA(),a.YNc(3,Q,2,1,"mat-form-field",32),a.YNc(4,O,2,1,"ng-template",null,33,a.W1O),a.YNc(6,E,2,1,"span",34),a.qZA()),2&e){const e=t.$implicit,i=a.MAs(5),r=a.oxw(2);a.xp6(2),a.hij("",e.title,":"),a.xp6(1),a.Q6J("ngIf",e.valueType!==r.storeService.valueTypes[0])("ngIfElse",i),a.xp6(3),a.Q6J("ngIf",e.unit)}}function L(e,t){if(1&e&&(a.TgZ(0,"div",27),a.TgZ(1,"div",28),a._uU(2,"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0438 \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA(),a.TgZ(3,"ul",29),a.YNc(4,D,7,4,"li",30),a.qZA(),a.qZA()),2&e){const e=a.oxw();a.xp6(4),a.Q6J("ngForOf",e.productParameters)}}const M=function(){return["/admin","types","create"]},j=[{path:"",component:(()=>{class e{constructor(e,t,i,r,o,s,n,c,a,u){this.storeService=e,this._dialog=t,this._fileUploadService=i,this._formBuilder=r,this._http=o,this._router=s,this._productService=n,this._productTypeService=c,this._angularFireDatabase=a,this._angularFirestore=u,this.percentage=0,this.productParameters=[],this.selectedFiles=[],this.submitted=!1}createProduct(){let e="",t=[];if(localStorage.getItem("user")){const t=JSON.parse(localStorage.getItem("user"));t.email&&(e=t.email)}for(let r=0;r<this.productParameters.length;r++)t[r]={title:this.productParameters[r].title,value:this.formParameters.at(r).value,valueType:this.productParameters[r].valueType},this.productParameters[r].valueType===this.storeService.valueTypes[0]&&(t[r].unit=this.productParameters[r].unit);this.submitted=!0;const i={date:(new Date).toString(),info:this.form.value.info,images:[],parameters:t.concat(),price:this.form.value.price.replace(/\s/g,""),title:this.form.value.title,type:this.form.value.type,history:[{email:e,date:(new Date).toString()}]};this._productService.create(i).then(e=>{const t=Object.assign(Object.assign({},i),{id:e.key});this.selectedFiles.length?this.onUploadImages(t,this.selectedFiles):this.updateProduct(t)})}get formParameters(){return this.form.get("formParameters")}getTypesList(){this._getTypesSubscription=this._productTypeService.getTypes().subscribe(e=>{this.types=e,this.types.sort((e,t)=>e.title<t.title?-1:e.title>t.title?1:0)})}inputJustNumbers(e){e.keyCode>47&&e.keyCode<58||190===e.keyCode||8===e.keyCode||46===e.keyCode||9===e.keyCode||27===e.keyCode||37===e.keyCode||39===e.keyCode||e.preventDefault()}isProductTitleOnServer(e,t){return!!t.find(t=>t.title.trim().toLowerCase()===e.trim().toLowerCase())}newFormParameterItem(e){let t;return t=e?[s.kI.required,s.kI.pattern(/^\d+(,\d{3})*(\.\d{1,2})?$/)]:[s.kI.required],new s.NI("",t)}ngOnDestroy(){var e,t;this._getTypesSubscription.unsubscribe(),null===(e=this._createProductSubscription)||void 0===e||e.unsubscribe(),null===(t=this._imagesSubscription)||void 0===t||t.unsubscribe()}ngOnInit(){this.form=this._formBuilder.group({formParameters:this._formBuilder.array([]),info:new s.NI(null,s.kI.required),price:new s.NI("",[s.kI.required,s.kI.pattern(/^\d+(,\d{3})*(\.\d{1,2})?$/)]),title:new s.NI(null,s.kI.required),type:new s.NI(null,s.kI.required)}),this.getTypesList()}onFileSelected(e){this.selectFiles(e.target.files)}onUploadImages(e,t){t.forEach((t,i,r)=>{const o=new n.p(t.file);i===r.length-1&&(this._imagesSubscription=this.storeService.imagesArray.subscribe(t=>{if(r.length===t.length){t.sort((e,t)=>e.index-t.index);for(let i=0;i<t.length;i++)e.images.push({index:t[i].index,name:t[i].name,original:t[i].original,size:t[i].size});this.updateProduct(e)}})),this._fileUploadService.pushImageToStorage(o,i,e.type,e.id).subscribe(e=>{this.percentage=Math.round(e||0)},e=>{})})}productTypeChange(e){this._productTypeService.getType(e.value).subscribe(e=>{this.productParameters=[],this.formParameters.clear(),e.parameters&&this.showParameters(e.parameters)})}removeSelectedFile(e){const t=this.selectedFiles.filter((t,i)=>e!==i);this.selectedFiles=t.concat()}selectFiles(e){Array.from(e).forEach(e=>{let t,i=new FileReader;i.onloadend=r=>{t=i.result,this.selectedFiles.push({file:e,image:t,isOnStorage:!1,name:e.name,size:e.size})},i.readAsDataURL(e)})}showParameters(e){e.forEach(e=>{this.formParameters.push(this.newFormParameterItem(e.valueType===this.storeService.valueTypes[0]))}),this.productParameters=e.concat()}showPopupConfirm(){this._dialog.open(c.z,{width:"400px",data:{title:"\u0412\u0456\u0434\u0441\u0443\u0442\u043d\u0454 \u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u043d\u044f.",text:"<p>\u0412\u0438 \u043d\u0435 \u0434\u043e\u0434\u0430\u043b\u0438 \u0436\u043e\u0434\u043d\u043e\u0433\u043e \u0444\u043e\u0442\u043e \u0442\u043e\u0432\u0430\u0440\u0443.<br>\u0411\u0430\u0436\u0430\u0454\u0442\u0435 \u043f\u0440\u043e\u0434\u043e\u0432\u0436\u0438\u0442\u0438 \u0431\u0435\u0437 \u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u044c?</p>",cancelTxt:"\u0411\u0435\u0437 \u0444\u043e\u0442\u043e",confirmTxt:"\u0414\u043e\u0434\u0430\u0442\u0438 \u0444\u043e\u0442\u043e"}}).afterClosed().subscribe(e=>{e||(this.storeService.showPreloader.next(!0),this.createProduct())})}submit(){if(this.form.invalid)return;if(!this.selectedFiles.length)return void this.showPopupConfirm();this.storeService.showPreloader.next(!0);const e=this._productService.getAll().subscribe(t=>{this.isProductTitleOnServer(this.form.value.title,t)?(this.form.controls.title.setErrors({busyTitle:!0}),this.storeService.showPreloader.next(!1)):this.createProduct(),e.unsubscribe()})}titleFocusOut(e){const t=this._productService.getAll().subscribe(i=>{this.isProductTitleOnServer(e.target.value,i)&&this.form.controls.title.setErrors({busyTitle:!0}),t.unsubscribe()})}updateProduct(e){this._productService.update(e).then(()=>{var t;null===(t=this._imagesSubscription)||void 0===t||t.unsubscribe(),this.form.reset(),this.submitted=!1,this.storeService.showPreloader.next(!1),this.storeService.imagesArray.next([]),this._router.navigate(["/catalog",e.type,e.id])},e=>{})}updateTypes(){this.getTypesList()}}return e.\u0275fac=function(t){return new(t||e)(a.Y36(u.d),a.Y36(l.uw),a.Y36(d.J),a.Y36(s.qu),a.Y36(f.eN),a.Y36(o.F0),a.Y36(m.M),a.Y36(p.c),a.Y36(g.KQ),a.Y36(h.ST))},e.\u0275cmp=a.Xpm({type:e,selectors:[["app-add-product"]],decls:48,vars:11,consts:[[1,"site__centered"],[1,"nice-form",3,"formGroup","ngSubmit"],[1,"site__title"],[1,"nice-form__row"],[1,"nice-form__cell"],["appearance","outline"],["formControlName","type",3,"selectionChange"],["value",""],[4,"ngIf"],[1,"nice-form__notice"],[1,"nice-form__cell","nice-form__cell_justify"],["target","_blank",1,"site__link",3,"routerLink"],[1,"site__link",3,"click"],["type","text","formControlName","title","matInput","",3,"focusout"],["type","button","mat-raised-button","",1,"btn","btn_small",3,"click"],["hidden","","type","file","name","photo","accept","image/png, image/jpeg","multiple","",3,"change"],["fileInput",""],["class","nice-form__row",4,"ngIf"],["formControlName","info"],["placeholder","0.00","mask","separator.2","type","text","formControlName","price","matInput","",3,"keydown"],["formArrayName","formParameters","class","nice-form__row",4,"ngIf"],["type","submit",1,"btn","nice-form__submit",3,"disabled"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["class","nice-form__error",4,"ngIf"],[1,"nice-form__error"],[3,"selectedFiles","removeFile"],["formArrayName","formParameters",1,"nice-form__row"],[1,"nice-form__title"],[1,"nice-list"],["class","nice-list__item",4,"ngFor","ngForOf"],[1,"nice-list__item"],["class","nice-form__mini-field","appearance","outline",4,"ngIf","ngIfElse"],["numberInput",""],["class","nice-form__unit",4,"ngIf"],["appearance","outline",1,"nice-form__mini-field"],["type","text","matInput","",3,"formControlName"],["appearance","outline",1,"nice-form__mini-field",3,"keydown"],[1,"nice-form__unit"]],template:function(e,t){if(1&e){const e=a.EpF();a.TgZ(0,"div",0),a.TgZ(1,"form",1),a.NdJ("ngSubmit",function(){return t.submit()}),a.TgZ(2,"h1",2),a._uU(3,"\u0414\u043e\u0434\u0430\u0442\u0438 \u0442\u043e\u0432\u0430\u0440"),a.qZA(),a.TgZ(4,"div",3),a.TgZ(5,"div",4),a.TgZ(6,"mat-form-field",5),a.TgZ(7,"mat-label"),a._uU(8,"\u0422\u0438\u043f \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA(),a.TgZ(9,"mat-select",6),a.NdJ("selectionChange",function(e){return t.productTypeChange(e)}),a.TgZ(10,"mat-option",7),a._uU(11,"\u041e\u0431\u0435\u0440\u0456\u0442\u044c \u0442\u0438\u043f \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA(),a.YNc(12,w,2,1,"ng-container",8),a.qZA(),a.qZA(),a.YNc(13,N,2,1,"div",8),a.TgZ(14,"div",9),a._uU(15,"\u041f\u0456\u0441\u043b\u044f \u0441\u0442\u0432\u043e\u0440\u0435\u043d\u043d\u044f \u0442\u043e\u0432\u0430\u0440\u0443 \u0437\u043c\u0456\u043d\u0438\u0442\u0438 \u0439\u043e\u0433\u043e \u0442\u0438\u043f \u0432\u0436\u0435 \u043d\u0435 \u0431\u0443\u0434\u0435 \u043c\u043e\u0436\u043b\u0438\u0432\u043e\u0441\u0442\u0456."),a.qZA(),a.qZA(),a.TgZ(16,"div",10),a.TgZ(17,"a",11),a.TgZ(18,"span"),a._uU(19,"\u0414\u043e\u0434\u0430\u0442\u0438 \u043d\u043e\u0432\u0438\u0439 \u0442\u0438\u043f"),a.qZA(),a.qZA(),a.TgZ(20,"button",12),a.NdJ("click",function(){return t.updateTypes()}),a.TgZ(21,"span"),a._uU(22,"\u041e\u043d\u043e\u0432\u0438\u0442\u0438 \u0442\u0438\u043f\u0438"),a.qZA(),a.qZA(),a.qZA(),a.qZA(),a.TgZ(23,"div",3),a.TgZ(24,"mat-form-field",5),a.TgZ(25,"mat-label"),a._uU(26,"\u041d\u0430\u0437\u0432\u0430 \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA(),a.TgZ(27,"input",13),a.NdJ("focusout",function(e){return t.titleFocusOut(e)}),a.qZA(),a.qZA(),a.YNc(28,J,3,2,"div",8),a.qZA(),a.TgZ(29,"div",3),a.TgZ(30,"button",14),a.NdJ("click",function(){return a.CHM(e),a.MAs(33).click()}),a._uU(31,"\u0417\u0430\u0432\u0430\u043d\u0442\u0430\u0436\u0442\u0435 \u0444\u043e\u0442\u043e \u0442\u043e\u0432\u0430\u0440\u0443"),a.qZA(),a.TgZ(32,"input",15,16),a.NdJ("change",function(e){return t.onFileSelected(e)}),a.qZA(),a.qZA(),a.YNc(34,P,2,1,"div",17),a.TgZ(35,"div",3),a._UZ(36,"quill-editor",18),a.YNc(37,C,2,1,"div",8),a.qZA(),a.TgZ(38,"div",3),a.TgZ(39,"mat-form-field",5),a.TgZ(40,"mat-label"),a._uU(41,"\u0412\u0430\u0440\u0442\u0456\u0441\u0442\u044c \u0442\u043e\u0432\u0430\u0440\u0443, \u0433\u0440\u043d"),a.qZA(),a.TgZ(42,"input",19),a.NdJ("keydown",function(e){return t.inputJustNumbers(e)}),a.qZA(),a.qZA(),a.YNc(43,Y,2,1,"div",8),a.qZA(),a.YNc(44,L,5,1,"div",20),a.TgZ(45,"div",3),a.TgZ(46,"button",21),a._uU(47,"\u0414\u043e\u0434\u0430\u0442\u0438 \u0442\u043e\u0432\u0430\u0440"),a.qZA(),a.qZA(),a.qZA(),a.qZA()}2&e&&(a.xp6(1),a.Q6J("formGroup",t.form),a.xp6(11),a.Q6J("ngIf",t.types),a.xp6(1),a.Q6J("ngIf",t.form.get("type").touched&&t.form.get("type").invalid),a.xp6(4),a.Q6J("routerLink",a.DdM(10,M)),a.xp6(11),a.Q6J("ngIf",t.form.get("title").touched&&t.form.get("title").invalid),a.xp6(6),a.Q6J("ngIf",t.selectedFiles.length>0),a.xp6(3),a.Q6J("ngIf",t.form.get("info").touched&&t.form.get("info").invalid),a.xp6(6),a.Q6J("ngIf",t.form.get("price").touched&&t.form.get("price").invalid),a.xp6(1),a.Q6J("ngIf",t.productParameters.length>0),a.xp6(2),a.Q6J("disabled",t.form.invalid||t.submitted))},directives:[s._Y,s.JL,s.sg,Z.KE,Z.hX,v.gD,s.JJ,s.u,_.ey,r.O5,o.yS,s.Fj,T.Nt,y.lW,b.g6,q.hx,r.sg,A.p,s.CE],styles:[""]}),e})()}];let z=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=a.oAB({type:e}),e.\u0275inj=a.cJS({imports:[[o.Bz.forChild(j)],o.Bz]}),e})();var B=i(17),$=i(7523),R=i(5260),H=i(440);let W=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=a.oAB({type:e}),e.\u0275inj=a.cJS({imports:[[z,r.ez,s.u5,y.ot,Z.lN,T.c,v.LD,q.yI.forRoot(),R.W,B.D,b.fi.forRoot(),s.UX,H.a,$.O]]}),e})()}}]);