(self.webpackChunkbuildmarket_angular=self.webpackChunkbuildmarket_angular||[]).push([[36],{7036:(e,t,i)=>{"use strict";i.r(t),i.d(t,{EditPageModule:()=>j});var r=i(1116),s=i(1334),o=i(4689),n=i(1462),a=i(2193),u=i(2925),c=i(5366),l=i(6455),d=i(2935),p=i(5763),m=i(5031),f=i(8207),h=i(3070),g=i(9550),_=i(4369),v=i(1285),Z=i(1601),b=i(6761),I=i(7672);function y(e,t){if(1&e&&(c.TgZ(0,"div"),c._uU(1,"\u0422\u0438\u043f \u0442\u043e\u0432\u0430\u0440\u0443: "),c.TgZ(2,"strong"),c._uU(3),c.qZA(),c.qZA()),2&e){const e=c.oxw(2);c.xp6(3),c.Oqu(e.currentType.title)}}function w(e,t){1&e&&(c.TgZ(0,"div",19),c._uU(1,"\u0412\u0432\u0435\u0434\u0456\u0442\u044c \u043d\u0430\u0437\u0432\u0443 \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA())}function T(e,t){if(1&e&&(c.TgZ(0,"div"),c.YNc(1,w,2,0,"div",18),c.qZA()),2&e){const e=c.oxw(2);c.xp6(1),c.Q6J("ngIf",e.form.get("title").errors.required)}}function x(e,t){if(1&e){const e=c.EpF();c.TgZ(0,"div",5),c.TgZ(1,"app-selected-files",20),c.NdJ("removeFile",function(t){return c.CHM(e),c.oxw(2).removeSelectedFile(t)}),c.qZA(),c.qZA()}if(2&e){const e=c.oxw(2);c.xp6(1),c.Q6J("selectedFiles",e.selectedFiles)}}function S(e,t){1&e&&(c.TgZ(0,"div",19),c._uU(1,"\u0414\u043e\u0434\u0430\u0439\u0442\u0435 \u0456\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0456\u044e \u043e \u0442\u043e\u0432\u0430\u0440\u0456"),c.qZA())}function q(e,t){if(1&e&&(c.TgZ(0,"div"),c.YNc(1,S,2,0,"div",18),c.qZA()),2&e){const e=c.oxw(2);c.xp6(1),c.Q6J("ngIf",e.form.get("info").errors.required)}}function A(e,t){1&e&&(c.TgZ(0,"div",19),c._uU(1,"\u0412\u0432\u0435\u0434\u0456\u0442\u044c \u0432\u0430\u0440\u0442\u0456\u0441\u0442\u044c \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA())}function F(e,t){if(1&e&&(c.TgZ(0,"div"),c.YNc(1,A,2,0,"div",18),c.qZA()),2&e){const e=c.oxw(2);c.xp6(1),c.Q6J("ngIf",e.form.get("price").errors.required)}}function N(e,t){if(1&e&&(c.TgZ(0,"mat-form-field",29),c._UZ(1,"input",30),c.qZA()),2&e){const e=c.oxw().index;c.xp6(1),c.s9C("formControlName",e)}}function k(e,t){if(1&e){const e=c.EpF();c.TgZ(0,"mat-form-field",31),c.NdJ("keydown",function(t){return c.CHM(e),c.oxw(4).inputJustNumbers(t)}),c._UZ(1,"input",30),c.qZA()}if(2&e){const e=c.oxw().index;c.xp6(1),c.s9C("formControlName",e)}}function C(e,t){if(1&e&&(c.TgZ(0,"span",32),c._uU(1),c.qZA()),2&e){const e=c.oxw().$implicit;c.xp6(1),c.Oqu(e.unit)}}function J(e,t){if(1&e&&(c.TgZ(0,"li",25),c.TgZ(1,"div"),c._uU(2),c.qZA(),c.YNc(3,N,2,1,"mat-form-field",26),c.YNc(4,k,2,1,"ng-template",null,27,c.W1O),c.YNc(6,C,2,1,"span",28),c.qZA()),2&e){const e=t.$implicit,i=c.MAs(5),r=c.oxw(3);c.xp6(2),c.hij("",e.title,":"),c.xp6(1),c.Q6J("ngIf",e.valueType!==r.storeService.valueTypes[0])("ngIfElse",i),c.xp6(3),c.Q6J("ngIf",e.unit)}}function P(e,t){if(1&e&&(c.TgZ(0,"div",21),c.TgZ(1,"div",22),c._uU(2,"\u041f\u0430\u0440\u0430\u043c\u0435\u0442\u0440\u0438 \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA(),c.TgZ(3,"ul",23),c.YNc(4,J,7,4,"li",24),c.qZA(),c.qZA()),2&e){const e=c.oxw(2);c.xp6(4),c.Q6J("ngForOf",e.productParameters)}}function U(e,t){if(1&e){const e=c.EpF();c.TgZ(0,"form",3),c.NdJ("ngSubmit",function(){return c.CHM(e),c.oxw().submit()}),c.TgZ(1,"h2",4),c._uU(2,"\u0420\u0435\u0434\u0430\u0433\u0443\u0432\u0430\u043d\u043d\u044f \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA(),c.TgZ(3,"div",5),c.TgZ(4,"div",6),c.YNc(5,y,4,1,"div",7),c.qZA(),c.qZA(),c.TgZ(6,"div",5),c.TgZ(7,"mat-form-field",8),c.TgZ(8,"mat-label"),c._uU(9,"\u041d\u0430\u0437\u0432\u0430 \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA(),c._UZ(10,"input",9),c.qZA(),c.YNc(11,T,2,1,"div",7),c.qZA(),c.TgZ(12,"div",5),c.TgZ(13,"button",10),c.NdJ("click",function(){return c.CHM(e),c.MAs(16).click()}),c._uU(14,"\u0417\u0430\u0432\u0430\u043d\u0442\u0430\u0436\u0442\u0435 \u0444\u043e\u0442\u043e \u0442\u043e\u0432\u0430\u0440\u0443"),c.qZA(),c.TgZ(15,"input",11,12),c.NdJ("change",function(t){return c.CHM(e),c.oxw().onFileSelected(t)}),c.qZA(),c.qZA(),c.YNc(17,x,2,1,"div",13),c.TgZ(18,"div",5),c._UZ(19,"quill-editor",14),c.YNc(20,q,2,1,"div",7),c.qZA(),c.TgZ(21,"div",5),c.TgZ(22,"mat-form-field",8),c.TgZ(23,"mat-label"),c._uU(24,"\u0412\u0430\u0440\u0442\u0456\u0441\u0442\u044c \u0442\u043e\u0432\u0430\u0440\u0443, \u0433\u0440\u043d"),c.qZA(),c.TgZ(25,"input",15),c.NdJ("keydown",function(t){return c.CHM(e),c.oxw().inputJustNumbers(t)}),c.qZA(),c.qZA(),c.YNc(26,F,2,1,"div",7),c.qZA(),c.YNc(27,P,5,1,"div",16),c.TgZ(28,"div",5),c.TgZ(29,"button",17),c._uU(30,"\u041e\u043d\u043e\u0432\u0438\u0442\u0438 \u0442\u043e\u0432\u0430\u0440"),c.qZA(),c.qZA(),c.qZA()}if(2&e){const e=c.oxw();c.Q6J("formGroup",e.form),c.xp6(5),c.Q6J("ngIf",!!e.currentType),c.xp6(6),c.Q6J("ngIf",e.form.get("title").touched&&e.form.get("title").invalid),c.xp6(6),c.Q6J("ngIf",e.selectedFiles.length>0),c.xp6(3),c.Q6J("ngIf",e.form.get("info").touched&&e.form.get("info").invalid),c.xp6(6),c.Q6J("ngIf",e.form.get("price").touched&&e.form.get("price").invalid),c.xp6(1),c.Q6J("ngIf",e.productParameters.length>0),c.xp6(2),c.Q6J("disabled",e.form.invalid||e.submitted)}}function Y(e,t){1&e&&c._UZ(0,"mat-spinner",33)}const O=[{path:"",component:(()=>{class e{constructor(e,t,i,r,s,o,n,a){this.storeService=e,this._dialog=t,this._fileUploadService=i,this._formBuilder=r,this._router=s,this._productService=o,this._productTypeService=n,this._route=a,this.canShowContent=!1,this.percentage=0,this.productParameters=[],this.selectedFiles=[],this.submitted=!1,this._uploadedFiles=[]}addImagesArray(e){this._imagesSubscription=this.storeService.imagesArray.subscribe(t=>{if(e.length===t.length){t.sort((e,t)=>e.index-t.index);for(let e=0;e<t.length;e++)this.product.images.push({index:t[e].index,name:t[e].name,original:t[e].original,size:t[e].size});this.saveData()}})}downloadFilesFromStorage(e){let t=[];e.forEach((e,i)=>{t.push(e?Object.assign(e):{index:i,name:"error",original:"error",size:0})}),t.sort((e,t)=>e.index-t.index),t.forEach(e=>{this.selectedFiles.push({image:e.original,isOnStorage:"error"!==e.original,name:e.name,size:e.size})})}enumerationNewFiles(e){e.forEach((e,t,i)=>{if(t===i.length-1&&this.addImagesArray(i),!e.isOnStorage&&e.file){const i=new u.p(e.file);this._fileUploadServiceSubscription=this._fileUploadService.pushImageToStorage(i,t,this.product.type,this.product.id,this._uploadedFiles).subscribe(e=>{this.percentage=Math.round(e||0)},e=>{console.error("error ",e)}),this._uploadedFiles=[]}})}enumerationUploadedFiles(e){let t=!1;e.forEach((i,r,s)=>{i.isOnStorage?this._uploadedFiles.push({index:r,name:i.name,original:i.image,size:i.size}):t=!0,r===s.length-1&&(t?this.enumerationNewFiles(e):(this.storeService.imagesArray.next(this._uploadedFiles),this.addImagesArray(s)))})}get formParameters(){return this.form.get("formParameters")}getCurrentType(){this._getTypesSubscription=this._productTypeService.getTypes().subscribe(e=>{const t=e.find(e=>e.id===this.form.get("type").value);t&&(this.currentType=t),this.currentType.parameters&&this.showParameters(this.currentType.parameters),this.product.images&&this.downloadFilesFromStorage(this.product.images),this.canShowContent=!0})}inputJustNumbers(e){e.keyCode>47&&e.keyCode<58||190===e.keyCode||8===e.keyCode||46===e.keyCode||9===e.keyCode||27===e.keyCode||37===e.keyCode||39===e.keyCode||e.preventDefault()}newFormParameterItem(e,t){let i;return i=t?[n.kI.required,n.kI.pattern(/^\d+(,\d{3})*(\.\d{1,2})?$/)]:[n.kI.required],new n.NI(e,i)}ngOnInit(){this.form=this._formBuilder.group({formParameters:this._formBuilder.array([]),info:new n.NI(null,n.kI.required),price:new n.NI("",[n.kI.required,n.kI.pattern(/^\d+(,\d{3})*(\.\d{1,2})?$/)]),title:new n.NI(null,n.kI.required),type:new n.NI(null,n.kI.required)}),this._routeSubscription=this._route.params.pipe((0,o.w)(e=>(this._productID=e.productID,this._typeID=e.typeID,this._productService.getByTypeAndID(e.typeID,e.productID)))).subscribe(e=>{this.product=e,this.form=new n.cw({formParameters:this._formBuilder.array([]),info:new n.NI(this.product.info,n.kI.required),price:new n.NI(this.product.price,[n.kI.required,n.kI.pattern(/^\d+(,\d{3})*(\.\d{1,2})?$/)]),title:new n.NI(this.product.title,n.kI.required),type:new n.NI(this.product.type,n.kI.required)}),this.getCurrentType()})}ngOnDestroy(){var e,t,i,r,s,o,n;null===(e=this._createTypeSubscription)||void 0===e||e.unsubscribe(),null===(t=this._createProductSubscription)||void 0===t||t.unsubscribe(),null===(i=this._fileUploadServiceSubscription)||void 0===i||i.unsubscribe(),null===(r=this._getTypesSubscription)||void 0===r||r.unsubscribe(),null===(s=this._imagesSubscription)||void 0===s||s.unsubscribe(),null===(o=this._routeSubscription)||void 0===o||o.unsubscribe(),null===(n=this._updateProductSubscription)||void 0===n||n.unsubscribe()}onFileSelected(e){this.selectFiles(e.target.files)}onUploadImages(e){this.enumerationUploadedFiles(e)}removeSelectedFile(e){this.selectedFiles[e].isOnStorage&&this._fileUploadService.deleteImage(this._typeID,this._productID,e.toString(),this.selectedFiles[e].name);const t=this.selectedFiles.filter((t,i)=>e!==i);this.selectedFiles=t.concat()}saveData(){this._productService.update(this.product).then(()=>{var e;null===(e=this._imagesSubscription)||void 0===e||e.unsubscribe(),this.form.reset(),this.submitted=!1,this.storeService.showPreloader.next(!1),this._router.navigate(["/catalog",this.product.type,this.product.id])},e=>{console.error("update error: ",e)})}selectFiles(e){Array.from(e).forEach(e=>{let t,i=new FileReader;i.onloadend=r=>{t=i.result,this.selectedFiles.push({file:e,image:t,isOnStorage:!1,name:e.name,size:e.size})},i.readAsDataURL(e)})}showParameters(e){e.forEach(e=>{let t;this.product.parameters&&(t=this.product.parameters.find(t=>t.title===e.title)),this.formParameters.push(this.newFormParameterItem(t?t.value:"",e.valueType===this.storeService.valueTypes[0]))}),this.productParameters=e.concat()}showPopupConfirm(){const e=this._dialog.open(a.z,{width:"400px",data:{title:"\u0412\u0456\u0434\u0441\u0443\u0442\u043d\u0454 \u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u043d\u044f.",text:"<p>\u0412\u0438 \u043d\u0435 \u0434\u043e\u0434\u0430\u043b\u0438 \u0436\u043e\u0434\u043d\u043e\u0433\u043e \u0444\u043e\u0442\u043e \u0442\u043e\u0432\u0430\u0440\u0443.<br>\u0411\u0430\u0436\u0430\u0454\u0442\u0435 \u043f\u0440\u043e\u0434\u043e\u0432\u0436\u0438\u0442\u0438 \u0431\u0435\u0437 \u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u044c?</p>",cancelTxt:"\u0411\u0435\u0437 \u0444\u043e\u0442\u043e",confirmTxt:"\u0414\u043e\u0434\u0430\u0442\u0438 \u0444\u043e\u0442\u043e"}}).afterClosed().subscribe(t=>{t||this.updateProduct(),e.unsubscribe()})}submit(){this.form.invalid||(this.selectedFiles.length?this.updateProduct():this.showPopupConfirm())}updateProduct(){let e="",t=[];if(this.storeService.showPreloader.next(!0),localStorage.getItem("user")){const t=JSON.parse(localStorage.getItem("user"));t.email&&(e=t.email)}for(let i=0;i<this.productParameters.length;i++)t[i]={title:this.productParameters[i].title,value:this.formParameters.at(i).value,valueType:this.productParameters[i].valueType},this.productParameters[i].valueType===this.storeService.valueTypes[0]&&(t[i].unit=this.productParameters[i].unit);this.submitted=!0,this.product=Object.assign(Object.assign({},this.product),{history:[...this.product.history,{date:(new Date).toString(),email:e}],info:this.form.value.info,images:[],parameters:t.concat(),price:this.form.value.price.replace(/\s/g,""),title:this.form.value.title}),this.selectedFiles.length?this.onUploadImages(this.selectedFiles):this.saveData()}}return e.\u0275fac=function(t){return new(t||e)(c.Y36(l.d),c.Y36(d.uw),c.Y36(p.J),c.Y36(n.qu),c.Y36(s.F0),c.Y36(m.M),c.Y36(f.c),c.Y36(s.gz))},e.\u0275cmp=c.Xpm({type:e,selectors:[["app-edit-page"]],decls:4,vars:2,consts:[[1,"site__centered"],["class","nice-form",3,"formGroup","ngSubmit",4,"ngIf","ngIfElse"],["loading",""],[1,"nice-form",3,"formGroup","ngSubmit"],[1,"site__title"],[1,"nice-form__row"],[1,"nice-form__cell"],[4,"ngIf"],["appearance","outline"],["type","text","formControlName","title","matInput",""],["type","button","mat-raised-button","",1,"btn","btn_small",3,"click"],["hidden","","type","file","name","photo","accept","image/png, image/jpeg","multiple","",3,"change"],["fileInput",""],["class","nice-form__row",4,"ngIf"],["formControlName","info"],["placeholder","0.00","mask","separator.2","type","text","formControlName","price","matInput","",3,"keydown"],["formArrayName","formParameters","class","nice-form__row",4,"ngIf"],["type","submit",1,"btn","nice-form__submit",3,"disabled"],["class","nice-form__error",4,"ngIf"],[1,"nice-form__error"],[3,"selectedFiles","removeFile"],["formArrayName","formParameters",1,"nice-form__row"],[1,"nice-form__title"],[1,"nice-list"],["class","nice-list__item",4,"ngFor","ngForOf"],[1,"nice-list__item"],["class","nice-form__mini-field","appearance","outline",4,"ngIf","ngIfElse"],["numberInput",""],["class","nice-form__unit",4,"ngIf"],["appearance","outline",1,"nice-form__mini-field"],["type","text","matInput","",3,"formControlName"],["appearance","outline",1,"nice-form__mini-field",3,"keydown"],[1,"nice-form__unit"],[1,"loading-type-1"]],template:function(e,t){if(1&e&&(c.TgZ(0,"div",0),c.YNc(1,U,31,8,"form",1),c.YNc(2,Y,1,0,"ng-template",null,2,c.W1O),c.qZA()),2&e){const e=c.MAs(3);c.xp6(1),c.Q6J("ngIf",t.canShowContent)("ngIfElse",e)}},directives:[r.O5,n._Y,n.JL,n.sg,h.KE,h.hX,n.Fj,g.Nt,n.JJ,n.u,_.lW,v.g6,Z.hx,b.p,n.CE,r.sg,I.$g],styles:[""]}),e})()}];let D=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=c.oAB({type:e}),e.\u0275inj=c.cJS({imports:[[s.Bz.forChild(O)],s.Bz]}),e})();var E=i(3841),Q=i(5260),z=i(17),M=i(440),B=i(7523);let j=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=c.oAB({type:e}),e.\u0275inj=c.cJS({imports:[[r.ez,D,n.u5,_.ot,h.lN,g.c,E.LD,I.Cq,Z.yI.forRoot(),Q.W,z.D,v.fi.forRoot(),n.UX,M.a,B.O]]}),e})()}}]);